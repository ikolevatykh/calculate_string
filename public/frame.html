<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Calculate String</title>
  <style>
    body {
      width: 100px;
    }
    .block {
      white-space: pre-wrap;
      word-break: break-all;
      width: 100px;
      font-size: 12px;
      font-family: sans-serif;
    }
    .char {
      display: inline;
    }
  </style>
</head>
<body>
<div class="block" id="block" contenteditable></div>
<script>
  const range = document.createRange();

  function calc (str, browser) {
    if (!calculate.$block) {
      calculate.$block = document.getElementById('block');
    }
    const $block = calculate.$block;
    const arr = str.split('');
    $block.innerHTML = arr
            .map(char => `<span class="char">${char}</span>`)
            .join('');

    const $chars = document.querySelector("#block");

    if (browser === 'firefox') {
      range.selectNodeContents($chars);
    } else {
      range.selectNode($chars);
    }

    const rects = range.getClientRects();
    // for webkit: start with one, because zero element is root block
    let SHIFT_RECT = 1;
    if (browser === 'firefox') {
      SHIFT_RECT = 0;
    }

    let y = rects[SHIFT_RECT].y;
    const arrayStr = [];
    for (let i = 0; i < rects.length - SHIFT_RECT; i += 1) {
      if (y !== rects[i + SHIFT_RECT].y) {
        arrayStr.push('\n');
        y = rects[i + SHIFT_RECT].y;
        arrayStr.push(str[i]);
      } else {
        arrayStr.push(str[i]);
      }
    }

    return arrayStr.join('');
  }

  function calculate(str) {
    return new Promise(resolve => resolve(calc(str)));
  }

  window.addEventListener("message", function(e) {
    if (e.data.type === 'calc') {
      const result = calc(e.data.str, e.data.browser);

      top.postMessage({
        type: 'calc',
        time: e.data.time,
        str: result,
      }, '*');
    }
  },
  false);
</script>
</body>
</html>